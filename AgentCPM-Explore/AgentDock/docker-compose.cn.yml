# ============================================================
# AgentDock - China Build Configuration (with Aliyun mirrors)
# ============================================================
# 使用阿里云镜像源加速构建，适合中国大陆用户
#
# Usage:
#   docker compose -f docker-compose.cn.yml build
#   docker compose -f docker-compose.cn.yml up -d
#
# Version: 1.0.0
# ============================================================

name: agentdock

services:
  # --------------------------------------------------------
  # AgentDock Manager - Core orchestration service
  # --------------------------------------------------------
  agentdock-manager:
    image: agentdock-manager:cn
    container_name: agentdock-manager
    build:
      context: ./master
      dockerfile: dockerfile.cn
    ports:
      - "8080:8080"
    volumes:
      - ./master:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      MONGO_HOST: agentdock-mongodb
      MONGO_PORT: 27017
      MONGO_USER: ${MONGODB_USERNAME}
      MONGO_PASS: ${MONGODB_PASSWORD}
    depends_on:
      - agentdock-mongodb
    command: ["--workers", "4", "-t", "600", "-b", "0.0.0.0:8080"]
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/alive"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # --------------------------------------------------------
  # AgentDock MongoDB - Persistent storage for node states
  # --------------------------------------------------------
  agentdock-mongodb:
    image: mongo:7
    container_name: agentdock-mongodb
    volumes:
      - agentdock-dbfiles:/data/db
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 6G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "none"

  # --------------------------------------------------------
  # AgentDock Node - Full-feature MCP server
  # --------------------------------------------------------
  agentdock-node-full:
    image: agentdock-node:full-cn
    container_name: agentdock-node-full
    build:
      context: ./agentdock-node-full
      dockerfile: dockerfile.cn
    ports:
      - "8092:8088"
      - "8004:8000"
    environment:
      - PYTHONPATH=/app
      - DOCKER_HOST_IP=host.docker.internal
      - NO_PROXY=localhost,127.0.0.1
      - no_proxy=localhost,127.0.0.1
    volumes:
      - ./agentdock-node-full/data:/app/data
      - ./agentdock-node-full/filesystem:/app/filesystem
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 32G
        reservations:
          cpus: '0.5'
          memory: 2G

  # --------------------------------------------------------
  # AgentDock Node - Explore MCP server
  # --------------------------------------------------------
  agentdock-node-explore:
    image: agentdock-node:explore-cn
    container_name: agentdock-node-explore
    build:
      context: ./agentdock-node-explore
      dockerfile: Dockerfile.cn
    ports:
      - "8102:8088"
      - "8014:8000"
    environment:
      - PYTHONPATH=/app
      - DOCKER_HOST_IP=host.docker.internal
      - NO_PROXY=localhost,127.0.0.1
      - no_proxy=localhost,127.0.0.1
      - JINA_API_KEY=${JINA_API_KEY:-}
      - GOOGLE_SERP_API_KEY=${GOOGLE_SERP_API_KEY:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./agentdock-node-explore/data:/app/data
      - ./agentdock-node-explore/filesystem:/app/filesystem
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 16G
        reservations:
          cpus: '0.5'
          memory: 2G

volumes:
  agentdock-dbfiles:
